{% extends "langchain/base.html" %}

{% block title %}Monitor Interview: {{ session.title if session and session.title else "Session" }}{% endblock %}

{% block extra_css %}
<style>
    .transcript-container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        overflow-y: auto;
        margin-right: 20px;
        display: flex;
        flex-direction: column;
        flex: 2;
    }
    .controls-container {
        width: 350px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    .status-indicator {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        background-color: #6c757d;
        margin-right: 5px;
    }
    .status-indicator.active {
        background-color: #28a745;
    }
    .transcript-content {
        flex: 1;
        white-space: pre-wrap;
        font-family: 'Inter', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        height: 65vh;
        overflow-y: auto;
    }
    .interviewer-message {
        color: #4f46e5;
        font-weight: 500;
        margin-bottom: 10px;
    }
    .participant-message {
        color: #212529;
        margin-bottom: 20px;
    }
    .control-label {
        font-weight: 500;
        margin-bottom: 5px;
    }
    .emotion-chart {
        height: 200px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    .sentiment-indicator {
        height: 25px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
    }
    .sentiment-level {
        position: absolute;
        height: 100%;
        background: linear-gradient(to right, #dc3545, #ffc107, #28a745);
        width: 100%;
    }
    .sentiment-marker {
        position: absolute;
        height: 25px;
        width: 3px;
        background-color: black;
        top: 0;
        z-index: 1;
    }
    .interview-stats {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }
    .interview-stats li {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }
    .interview-stats .value {
        font-weight: 500;
    }
    .suggestion-box {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }
    .live-indicator {
        display: inline-flex;
        align-items: center;
        padding: 5px 10px;
        background-color: rgba(220, 53, 69, 0.1);
        border-radius: 20px;
        color: #dc3545;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .live-indicator .dot {
        height: 8px;
        width: 8px;
        background-color: #dc3545;
        border-radius: 50%;
        margin-right: 5px;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.3;
        }
        100% {
            opacity: 1;
        }
    }
    .topic-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 20px;
    }
    .topic-tag {
        background-color: #e9ecef;
        padding: 3px 8px;
        border-radius: 15px;
        font-size: 0.8rem;
    }
    .btn-toolbar {
        margin-top: auto;
    }
    .monitor-container {
        display: flex;
        gap: 20px;
    }
    
    /* AI Observer Styles */
    .ai-note {
        background-color: rgba(79, 70, 229, 0.05);
        border-left: 3px solid rgba(79, 70, 229, 0.5);
        padding: 8px 12px;
        margin-top: 5px;
        font-size: 0.9rem;
        color: #495057;
        font-style: italic;
    }
    .ai-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 5px;
    }
    .ai-tag {
        background-color: rgba(79, 70, 229, 0.1);
        color: #4f46e5;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    .mood-timeline {
        height: 100px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        margin-bottom: 15px;
        position: relative;
    }
    .mood-point {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #4f46e5;
        transform: translate(-50%, -50%);
    }
    .observer-message {
        background-color: rgba(79, 70, 229, 0.03);
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .observer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .observer-icon {
        color: #4f46e5;
        margin-right: 5px;
    }
    .observer-title {
        font-size: 0.8rem;
        font-weight: 500;
        color: #4f46e5;
    }
    .observer-status {
        font-size: 0.75rem;
        color: #6c757d;
    }
    .observer-content {
        padding: 10px 12px;
    }
    .tab-controls {
        margin-bottom: 15px;
    }
    .toggle-observer {
        display: inline-flex;
        align-items: center;
        font-size: 0.8rem;
        color: #495057;
        cursor: pointer;
        user-select: none;
        margin-bottom: 10px;
    }
    .toggle-observer input {
        margin-right: 5px;
    }
    .mood-indicator {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
    }
    .mood-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #6c757d;
    }
    .mood-bar {
        height: 5px;
        background: linear-gradient(to right, #dc3545, #ffc107, #28a745);
        border-radius: 2px;
        margin: 5px 0;
        position: relative;
    }
    .mood-marker {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #212529;
        border-radius: 50%;
        top: -2.5px;
        transform: translateX(-50%);
        transition: left 0.3s ease;
    }
    .key-insights {
        background-color: rgba(79, 70, 229, 0.05);
        border-radius: 8px;
        padding: 10px;
        margin-top: 15px;
    }
    .insight-item {
        display: flex;
        margin-bottom: 8px;
    }
    .insight-item i {
        color: #4f46e5;
        margin-right: 8px;
        margin-top: 2px;
    }
    .quick-suggestion:hover, .direct-intervention:hover {
        transform: translateY(-2px);
        transition: transform 0.2s;
    }
    .ai-suggestion {
        border-left: 3px solid #198754;
        text-align: left;
        transition: all 0.2s ease;
    }
    .ai-suggestion:hover {
        background-color: rgba(25, 135, 84, 0.1);
        transform: translateX(3px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3">Monitoring: {{ session.title if session and session.title else "Session" }}</h1>
            <div class="text-muted small">Session ID: {{ session_id }}</div>
        </div>
        <div class="d-flex align-items-center">
            <div class="live-indicator me-3">
                <span class="dot"></span> LIVE
            </div>
            <a href="/interview_details/{{ session_id }}" class="btn btn-sm btn-outline-secondary me-2">
                <i class="bi bi-info-circle me-1"></i> Session Details
            </a>
            <button id="end-session-btn" class="btn btn-sm btn-danger">
                <i class="bi bi-stop-circle me-1"></i> End Session
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- Transcript Column (Left) -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Live Transcript</h5>
                    <div>
                        <button id="refresh-btn" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                        <button id="copy-transcript-btn" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="bi bi-clipboard me-1"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="transcript-content" class="transcript-content">
                        <!-- Transcript messages will appear here -->
                        {% if session and session.messages %}
                            {% for message in session.messages %}
                                <div class="{% if message.role == 'assistant' %}interviewer-message{% else %}participant-message{% endif %}" data-message-id="{{ message.id }}">
                                    <strong>{% if message.role == 'assistant' %}AI Interviewer{% else %}Participant{% endif %}:</strong> {{ message.content }}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-dots fs-1 mb-3 d-block"></i>
                                <p>No messages yet. Waiting for the interview to begin...</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Researcher Controls -->
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Interview Controls</span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="suggestion-input" class="form-label">Suggest a question or follow-up:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="suggestion-input" placeholder="Type a suggested question for the interviewer...">
                            <button class="btn btn-primary" id="send-suggestion-btn">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                        <div class="form-text">This will be sent as a suggestion to the interviewer.</div>
                    </div>
                    
                    <!-- Quick Suggestion Buttons -->
                    <div class="mb-4">
                        <label class="form-label">Quick Suggestions:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="Ask why">Ask why</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="Please elaborate">Please elaborate</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="Provide an example">Provide an example</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="How does that make you feel?">How does that feel?</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="What challenges did you face?">Challenges faced?</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="What would you change?">What would you change?</button>
                        </div>
                    </div>
                    
                    <!-- AI Suggested Questions -->
                    <div class="mb-4">
                        <label class="form-label d-flex align-items-center">
                            <span>AI Suggested Questions:</span>
                            <span class="badge bg-primary ms-2"><i class="bi bi-robot"></i></span>
                            <button id="refresh-questions-btn" class="btn btn-sm btn-link p-0 ms-auto">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </label>
                        <div id="ai-suggested-questions" class="d-flex flex-column gap-2">
                            <div class="text-center text-muted small py-2">
                                <i class="bi bi-hourglass-split me-1"></i> Waiting for AI suggestions...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Intervention Options -->
                    <div class="mb-4">
                        <label class="form-label">Direct Interventions:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-warning direct-intervention" data-intervention="change-topic">
                                <i class="bi bi-arrow-right-circle"></i> Change Topic
                            </button>
                            <button class="btn btn-sm btn-info direct-intervention" data-intervention="pause">
                                <i class="bi bi-pause-circle"></i> Pause Briefly
                            </button>
                            <button class="btn btn-sm btn-success direct-intervention" data-intervention="go-deeper">
                                <i class="bi bi-arrow-down-circle"></i> Go Deeper
                            </button>
                            <button class="btn btn-sm btn-secondary direct-intervention" data-intervention="summarize">
                                <i class="bi bi-list-check"></i> Summarize So Far
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-primary" id="add-note-btn">
                            <i class="bi bi-journal-plus"></i> Add Research Note
                        </button>
                        <button class="btn btn-danger" id="end-interview-btn">
                            <i class="bi bi-x-circle"></i> End Interview
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Column (Right) -->
        <div class="col-lg-4">
            <!-- AI Observer Panel -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0">AI Observer</h5>
                        <div class="ms-2">
                            <span class="badge bg-primary">
                                <i class="bi bi-robot"></i>
                            </span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            <span class="status-indicator"></span>
                            <span id="observer-status" class="text-muted small">Initializing</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="tab-controls">
                        <label class="toggle-observer">
                            <input type="checkbox" id="observer-toggle" checked>
                            <span>Show AI observations</span>
                        </label>
                    </div>
                    
                    <!-- Current Participant Mood -->
                    <h6 class="mb-2">Participant Mood</h6>
                    <div class="mood-indicator">
                        <div class="mood-bar">
                            <div class="mood-marker" id="current-mood-marker" style="left: 50%;"></div>
                        </div>
                        <div class="mood-label">
                            <span>Negative</span>
                            <span>Neutral</span>
                            <span>Positive</span>
                        </div>
                    </div>
                    
                    <h6 class="mb-2">Mood Timeline</h6>
                    <div id="mood-timeline" class="mood-timeline">
                        <!-- Mood points will be added here -->
                    </div>
                    
                    <h6 class="mb-2">Detected Topics</h6>
                    <div id="topics-list" class="topic-list mb-3">
                        <!-- Topics will be added here -->
                    </div>
                    
                    <!-- AI Key Insights Section -->
                    <h6 class="mb-2">Key Insights</h6>
                    <div id="key-insights" class="key-insights mb-3">
                        <div class="text-center text-muted py-2">
                            <small>Insights will appear here as the interview progresses</small>
                        </div>
                    </div>
                    
                    <button id="generate-summary-btn" class="btn btn-primary w-100">
                        <i class="bi bi-lightbulb me-1"></i> Generate Insights
                    </button>
                </div>
            </div>
            
            <!-- Interview Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Session Stats</h5>
                </div>
                <div class="card-body">
                    <ul class="interview-stats">
                        <li>
                            <span class="label">Duration</span>
                            <span class="value" id="session-duration">00:00:00</span>
                        </li>
                        <li>
                            <span class="label">Messages</span>
                            <span class="value" id="message-count">
                                {{ session.messages|length if session and session.messages else 0 }}
                            </span>
                        </li>
                        <li>
                            <span class="label">Avg. Response Time</span>
                            <span class="value" id="avg-response-time">--</span>
                        </li>
                        <li>
                            <span class="label">Interviewer Talk %</span>
                            <span class="value" id="interviewer-talk-percent">--</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Observer Summary Modal -->
<div class="modal fade" id="observerSummaryModal" tabindex="-1" aria-labelledby="observerSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="observerSummaryModalLabel">AI Observer Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="copy-summary-btn">
                    <i class="bi bi-clipboard me-1"></i> Copy Summary
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNoteModalLabel">Add Research Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="note-text" class="form-label">Note:</label>
                    <textarea class="form-control" id="note-text" rows="4" placeholder="Add your research observation or note here..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Note Type:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="noteType" id="note-type-observation" value="observation" checked>
                        <label class="form-check-label" for="note-type-observation">
                            Observation
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="noteType" id="note-type-insight" value="insight">
                        <label class="form-check-label" for="note-type-insight">
                            Insight
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="noteType" id="note-type-question" value="question">
                        <label class="form-check-label" for="note-type-question">
                            Follow-up Question
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-note-btn">Save Note</button>
            </div>
        </div>
    </div>
</div>

<!-- End Interview Confirmation Modal -->
<div class="modal fade" id="endInterviewModal" tabindex="-1" aria-labelledby="endInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="endInterviewModalLabel">End Interview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Are you sure you want to end this interview?
                </div>
                <p>This will terminate the session and redirect the participant to the thank you page. The system will automatically generate an analysis based on the interview transcript.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-end-interview-btn">End Interview</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sessionId = '{{ session_id }}';
        const transcriptContainer = document.getElementById('transcript-container');
        const messageInput = document.getElementById('suggestion-input');
        const sendBtn = document.getElementById('send-suggestion-btn');
        const addNoteBtn = document.getElementById('add-note-btn');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const endInterviewBtn = document.getElementById('end-interview-btn');
        const confirmEndInterviewBtn = document.getElementById('confirm-end-interview-btn');
        
        // Initialize modals
        const addNoteModal = new bootstrap.Modal(document.getElementById('addNoteModal'));
        const endInterviewModal = new bootstrap.Modal(document.getElementById('endInterviewModal'));
        
        // Initialize socket.io connection
        function initSocketConnection() {
            // Connect to socket.io server for real-time updates
            if (typeof io !== 'undefined') {
                console.log("Setting up Socket.IO connection");
                
                // Try to reuse existing socket if available
                if (window.socket && window.socket.connected) {
                    console.log("Using existing socket connection");
                    joinMonitoringRoom(window.socket);
                    return;
                }
                
                // Create new socket connection with improved reliability options
                const options = {
                    reconnection: true,
                    reconnectionAttempts: 10,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    timeout: 20000,
                    // Prefer WebSocket transport but fall back to polling if needed
                    transports: ['websocket', 'polling']
                };
                
                try {
                    // First try to connect using the current page's origin
                    window.socket = io(window.location.origin, options);
                    
                    window.socket.on('connect', function() {
                        console.log("Socket connected successfully");
                        updateSocketStatus('connected');
                        joinMonitoringRoom(window.socket);
                    });
                    
                    window.socket.on('connect_error', function(error) {
                        console.error("Socket connection error:", error);
                        updateSocketStatus('error');
                        // Schedule a reconnection attempt
                        setTimeout(() => {
                            if (!window.socket.connected) {
                                console.log("Attempting to reconnect socket...");
                                window.socket.connect();
                            }
                        }, 3000);
                    });
                    
                    window.socket.on('disconnect', function() {
                        console.log("Socket disconnected");
                        updateSocketStatus('disconnected');
                    });
                    
                    window.socket.on('error', function(error) {
                        console.error("Socket error:", error);
                        updateSocketStatus('error');
                    });
                    
                } catch (error) {
                    console.error("Error initializing socket:", error);
                    updateSocketStatus('error');
                    
                    // Try again with CDN version if there's an issue
                    loadSocketIOFromCDN();
                }
            } else {
                console.error("Socket.IO not available");
                updateSocketStatus('unavailable');
                
                // Try to load it from CDN
                loadSocketIOFromCDN();
            }
        }

        // Load Socket.IO from CDN if not available
        function loadSocketIOFromCDN() {
            console.log("Loading Socket.IO from CDN");
            
            const script = document.createElement('script');
            script.src = 'https://cdn.socket.io/4.6.0/socket.io.min.js';
            script.crossOrigin = 'anonymous';
            
            script.onload = function() {
                console.log("Socket.IO loaded from CDN");
                initSocketConnection();
            };
            
            script.onerror = function(error) {
                console.error("Failed to load Socket.IO from CDN:", error);
                updateSocketStatus('failed');
                
                // Try a fallback version
                const fallbackScript = document.createElement('script');
                fallbackScript.src = 'https://cdn.socket.io/socket.io-3.0.5.js';
                fallbackScript.crossOrigin = 'anonymous';
                
                fallbackScript.onload = function() {
                    console.log("Socket.IO loaded from fallback CDN");
                    initSocketConnection();
                };
                
                fallbackScript.onerror = function() {
                    console.error("Failed to load Socket.IO from fallback CDN");
                    updateSocketStatus('failed');
                    
                    // Show manual refresh option
                    const statusEl = document.getElementById('connection-status');
                    if (statusEl) {
                        statusEl.innerHTML = '<span class="text-danger">Connection failed</span> <button class="btn btn-sm btn-outline-primary ms-2" onclick="window.location.reload()">Refresh</button>';
                    }
                };
                
                document.head.appendChild(fallbackScript);
            };
            
            document.head.appendChild(script);
        }

        // Join the monitoring room
        function joinMonitoringRoom(socket) {
            if (!socket) return;
            
            // Join monitoring room for this session
            socket.emit('join', {
                session_id: sessionId
            });
            
            // Setup event handlers for monitoring-specific events
            
            // Handle new messages from the interview
            socket.on('new_message', function(data) {
                console.log("Received new message:", data);
                if (data.message_id && data.content) {
                    // Add the message to the transcript
                    addMessageToTranscript(data.role, data.content, data.message_id);
                    
                    // Notify researcher if enabled
                    if (notifyEnabled) {
                        notifyNewMessage(data.role, data.content);
                    }
                } else if (data.message) {
                    // Handle legacy format
                    const message = data.message;
                    addMessageToTranscript(message.role, message.content, message.id);
                }
            });
            
            // Handle observations from AI observer
            socket.on('new_observation', function(data) {
                console.log("Received new observation:", data);
                if (data.observation) {
                    displayObservation(data.observation, data.message_id);
                }
            });
            
            // Handle new insights
            socket.on('new_insights', function(data) {
                console.log("Received new insights:", data);
                if (data.insights && data.insights.length > 0) {
                    updateInsights(data.insights);
                }
            });
            
            // Handle suggested questions
            socket.on('suggested_questions', function(data) {
                console.log("Received suggested questions:", data);
                if (data.questions && data.questions.length > 0) {
                    updateSuggestedQuestions(data.questions);
                }
            });
            
            // Handle errors
            socket.on('error', function(data) {
                console.error("Socket error:", data);
                showToast('Error', data.error || 'An unknown error occurred', 'danger');
            });
            
            // Handle successful room joining
            socket.on('joined_room', function(data) {
                console.log("Successfully joined room:", data);
                updateSocketStatus('monitoring');
            });
        }

        // Update the socket connection status display
        function updateSocketStatus(status) {
            const statusEl = document.getElementById('connection-status');
            if (!statusEl) return;
            
            switch (status) {
                case 'connected':
                    statusEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Connected</span>';
                    break;
                case 'disconnected':
                    statusEl.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>Disconnected</span>';
                    break;
                case 'error':
                    statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Connection Error</span>';
                    break;
                case 'monitoring':
                    statusEl.innerHTML = '<span class="text-success"><i class="bi bi-broadcast me-1"></i>Monitoring Active</span>';
                    break;
                case 'unavailable':
                    statusEl.innerHTML = '<span class="text-secondary"><i class="bi bi-dash-circle me-1"></i>WebSocket Unavailable</span>';
                    break;
                case 'failed':
                    statusEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Connection Failed</span>';
                    break;
                default:
                    statusEl.innerHTML = '<span class="text-secondary"><i class="bi bi-question-circle me-1"></i>Unknown Status</span>';
            }
        }
        
        // Track message timestamps for calculating statistics
        let messageTimestamps = [];
        let participantMessageCount = 0;
        let interviewerMessageCount = 0;
        let participantCharCount = 0;
        let interviewerCharCount = 0;
        let sessionStartTime = new Date();
        
        // Function to update session statistics
        function updateSessionStats() {
            // Update message count
            const messageCountElem = document.getElementById('message-count');
            const totalMessages = participantMessageCount + interviewerMessageCount;
            if (messageCountElem) {
                messageCountElem.textContent = totalMessages;
            }
            
            // Calculate and update duration
            const durationElem = document.getElementById('session-duration');
            if (durationElem) {
                const now = new Date();
                const diffMs = now - sessionStartTime;
                const hours = Math.floor(diffMs / (1000 * 60 * 60)).toString().padStart(2, '0');
                const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                const seconds = Math.floor((diffMs % (1000 * 60)) / 1000).toString().padStart(2, '0');
                durationElem.textContent = `${hours}:${minutes}:${seconds}`;
            }
            
            // Calculate and update average response time
            const avgResponseTimeElem = document.getElementById('avg-response-time');
            if (avgResponseTimeElem && messageTimestamps.length >= 3) {
                // We need at least 3 messages to calculate response time (participant, AI, participant)
                let totalResponseTime = 0;
                let responseCount = 0;
                
                for (let i = 2; i < messageTimestamps.length; i += 2) {
                    if (messageTimestamps[i] && messageTimestamps[i-1]) {
                        const responseTime = messageTimestamps[i] - messageTimestamps[i-1];
                        if (responseTime > 0) {
                            totalResponseTime += responseTime;
                            responseCount++;
                        }
                    }
                }
                
                if (responseCount > 0) {
                    const avgResponseTimeMs = totalResponseTime / responseCount;
                    const avgResponseTimeSec = Math.floor(avgResponseTimeMs / 1000);
                    avgResponseTimeElem.textContent = `${avgResponseTimeSec}s`;
                }
            }
            
            // Calculate and update interviewer talk percentage
            const interviewerTalkPercentElem = document.getElementById('interviewer-talk-percent');
            if (interviewerTalkPercentElem && totalMessages > 0) {
                // Method 1: By message count
                const interviewerPercentByCount = Math.round((interviewerMessageCount / totalMessages) * 100);
                
                // Method 2: By character count (more accurate)
                let interviewerPercentByChars = 0;
                if (participantCharCount + interviewerCharCount > 0) {
                    interviewerPercentByChars = Math.round((interviewerCharCount / (participantCharCount + interviewerCharCount)) * 100);
                }
                
                // Use character-based percentage if we have that data, otherwise fall back to message count
                const finalPercent = (interviewerCharCount > 0) ? interviewerPercentByChars : interviewerPercentByCount;
                interviewerTalkPercentElem.textContent = `${finalPercent}%`;
            }
        }
        
        // Process new messages for stats calculation
        socket.on('new_message', function(data) {
            if (data.session_id === sessionId && data.message) {
                const message = data.message;
                const timestamp = new Date(message.timestamp || Date.now());
                
                // Store message timestamp for response time calculation
                messageTimestamps.push(timestamp);
                
                // Update message counts
                if (message.role === 'assistant') {
                    interviewerMessageCount++;
                    if (message.content) {
                        interviewerCharCount += message.content.length;
                    }
                } else if (message.role === 'user') {
                    participantMessageCount++;
                    if (message.content) {
                        participantCharCount += message.content.length;
                    }
                }
                
                // Update stats
                updateSessionStats();
            }
        });
        
        // Update stats every 1 second for duration
        setInterval(updateSessionStats, 1000);
        
        // Listen for new messages
        socket.on('new_message', function(data) {
            if (data.session_id === sessionId && data.message) {
                console.log('New message received:', data.message);
                
                // Clear initial placeholder if present
                const placeholder = document.querySelector('.text-center.text-muted.py-5');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // Add message to the transcript
                const transcriptContent = document.getElementById('transcript-content');
                const messageDiv = document.createElement('div');
                
                if (data.message.role === 'assistant') {
                    messageDiv.className = 'interviewer-message';
                    messageDiv.innerHTML = `<strong>AI Interviewer:</strong> ${data.message.content}`;
                } else if (data.message.role === 'user') {
                    messageDiv.className = 'participant-message';
                    messageDiv.innerHTML = `<strong>Participant:</strong> ${data.message.content}`;
                } else if (data.message.role === 'system') {
                    messageDiv.className = 'system-message alert alert-info';
                    messageDiv.innerHTML = `<i class="bi bi-info-circle me-2"></i><strong>System:</strong> ${data.message.content}`;
                }
                
                // Add data attribute for message ID
                if (data.message.id) {
                    messageDiv.setAttribute('data-message-id', data.message.id);
                }
                
                // Add to transcript
                transcriptContent.appendChild(messageDiv);
                
                // Update message count
                const messageCount = document.getElementById('message-count');
                if (messageCount) {
                    messageCount.textContent = parseInt(messageCount.textContent || 0) + 1;
                }
                
                // Scroll to bottom 
                transcriptContent.scrollTop = transcriptContent.scrollHeight;
            }
        });
        
        // Listen for new observations from AI
        socket.on('new_observation', function(data) {
            if (data.session_id === sessionId && data.observation) {
                console.log('New observation:', data.observation);
                
                // Update status indicator
                const statusIndicator = document.querySelector('.status-indicator');
                if (statusIndicator) {
                    statusIndicator.classList.add('active');
                }
                
                // Update mood timeline if there's a mood value
                if (data.observation.mood !== undefined) {
                    const moodTimeline = document.getElementById('mood-timeline');
                    if (moodTimeline) {
                        const point = document.createElement('div');
                        point.className = 'mood-point';
                        
                        // Calculate position (mood is -10 to 10, translate to 0-100% height)
                        const x = Math.floor(Math.random() * 95) + 2; // Random horizontal position (2-97%)
                        const y = 100 - ((data.observation.mood + 10) / 20 * 100); // Vertical position based on mood
                        
                        point.style.left = `${x}%`;
                        point.style.top = `${y}%`;
                        
                        // Add tooltip with the note
                        if (data.observation.note) {
                            point.title = data.observation.note;
                        }
                        
                        moodTimeline.appendChild(point);
                    }
                }
                
                // Update topics list if there are tags
                if (data.observation.tags && data.observation.tags.length > 0) {
                    const topicsList = document.getElementById('topics-list');
                    if (topicsList) {
                        data.observation.tags.forEach(tag => {
                            // Check if tag already exists to avoid duplicates
                            if (!document.querySelector(`.topic-tag[data-tag="${tag}"]`)) {
                                const tagElem = document.createElement('span');
                                tagElem.className = 'topic-tag';
                                tagElem.setAttribute('data-tag', tag);
                                tagElem.textContent = tag;
                                topicsList.appendChild(tagElem);
                            }
                        });
                    }
                }
                
                // Update current mood if available
                if (data.observation.mood !== undefined) {
                    const moodMarker = document.getElementById('current-mood-marker');
                    if (moodMarker) {
                        // Convert mood from -10 to 10 scale to 0 to 100% position
                        const position = ((data.observation.mood + 10) / 20) * 100;
                        moodMarker.style.left = `${position}%`;
                    }
                    
                    // Add to key insights if there's a note
                    if (data.observation.note) {
                        addInsight(data.observation.note, 'observation', data.observation.tags || []);
                    }
                }
                
                // Update session stats
                updateSessionStats();
                
                // Update the observer status to show it's active
                const observerStatus = document.getElementById('observer-status');
                if (observerStatus) {
                    observerStatus.textContent = 'Active';
                    observerStatus.className = 'text-success small';
                }
            }
        });
        
        // Session completion handler
        function handleInterviewEnded() {
            console.log('Interview has ended');
            
            // Clear intervals
            if (checkStatusInterval) {
                clearInterval(checkStatusInterval);
            }
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            // Show notification to researcher
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show';
            notification.innerHTML = `
                <strong>Interview Completed!</strong> The interview has been ended and the interviewee has been thanked.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container-fluid').prepend(notification);
            
            // Disable controls
            if (document.getElementById('endSessionBtn')) {
                document.getElementById('endSessionBtn').disabled = true;
            }
            if (document.getElementById('suggestQuestionBtn')) {
                document.getElementById('suggestQuestionBtn').disabled = true;
            }
            document.querySelectorAll('.direct-intervention').forEach(btn => {
                btn.disabled = true;
            });
            
            // Add completed label to the title
            const pageTitle = document.querySelector('h1');
            if (pageTitle) {
                // Check if the badge already exists
                if (!pageTitle.querySelector('.badge.bg-success')) {
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'badge bg-success ms-2';
                    statusBadge.textContent = 'COMPLETED';
                    pageTitle.appendChild(statusBadge);
                }
            }
            
            // Change live indicator
            const liveIndicator = document.querySelector('.live-indicator');
            if (liveIndicator) {
                liveIndicator.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> COMPLETED</span>';
            }
            
            // Add view analysis button if it doesn't exist
            const actionButtonsContainer = document.querySelector('.d-flex.align-items-center');
            if (actionButtonsContainer && !document.getElementById('view-analysis-btn')) {
                const viewAnalysisBtn = document.createElement('a');
                viewAnalysisBtn.id = 'view-analysis-btn';
                viewAnalysisBtn.href = `/interview_details/${sessionId}`;
                viewAnalysisBtn.className = 'btn btn-sm btn-success me-2';
                viewAnalysisBtn.innerHTML = '<i class="bi bi-file-text me-1"></i> View Analysis';
                actionButtonsContainer.appendChild(viewAnalysisBtn);
            }
            
            // Update connection status
            updateSocketStatus('completed');
        }
        
        // Listen for session completion events
        socket.on('session_completed', function(data) {
            if (data.session_id === sessionId) {
                console.log('Session completed:', data);
                handleInterviewEnded();
            }
        });
        
        // Also listen for analysis completion
        socket.on('analysis_complete', function(data) {
            if (data.session_id === sessionId) {
                console.log('Analysis completed:', data);
                
                // Show notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-success alert-dismissible fade show';
                notification.innerHTML = `
                    <strong>Analysis Complete!</strong> The interview analysis is now ready to view.
                    <a href="/interview_details/${sessionId}" class="btn btn-sm btn-outline-success ms-3">View Analysis</a>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container-fluid').prepend(notification);
            }
        });
        
        // Function to update suggested questions UI
        function updateSuggestedQuestions(questions) {
            const container = document.getElementById('ai-suggested-questions');
            if (!container) return;
            
            // Clear existing content
            container.innerHTML = '';
            
            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted small py-2">
                        <i class="bi bi-exclamation-circle me-1"></i> No questions available yet
                    </div>
                `;
                return;
            }
            
            // Add each question as a button
            questions.forEach(question => {
                const button = document.createElement('button');
                button.className = 'btn btn-sm btn-outline-success ai-suggestion mb-1';
                button.setAttribute('data-suggestion', question.text);
                button.innerHTML = `<i class="bi bi-robot me-1"></i> ${question.text}`;
                container.appendChild(button);
                
                // Add click handler
                button.addEventListener('click', function() {
                    const suggestion = this.getAttribute('data-suggestion');
                    messageInput.value = suggestion;
                    sendBtn.click();
                });
            });
        }
        
        // Refresh questions button
        document.getElementById('refresh-questions-btn').addEventListener('click', function() {
            socket.emit('request_suggested_questions', { session_id: sessionId });
            showNotification('Refreshing', 'Requesting new question suggestions...', 'info');
        });
        
        // Send a suggestion to the interviewer
        sendBtn.addEventListener('click', function() {
            const message = messageInput.value.trim();
            if (message) {
                // Send the suggestion via socket
                socket.emit('researcher_message', {
                    session_id: sessionId,
                    message: {
                        role: 'system',
                        content: message,
                        type: 'suggestion'
                    }
                });
                
                // Clear input field
                messageInput.value = '';
                
                // Show confirmation
                showNotification('Suggestion Sent', 'Your suggestion has been sent to the interviewer.', 'success');
            }
        });
        
        // Allow pressing Enter to send
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });
        
        // End Interview button click
        endInterviewBtn.addEventListener('click', function() {
            endInterviewModal.show();
        });
        
        // Confirm End Interview button click
        confirmEndInterviewBtn.addEventListener('click', function() {
            // Call the API to end the interview
            fetch(`/api/session/${sessionId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    should_analyze: true,
                    end_reason: "Researcher terminated interview from monitor interface",
                    researcher_notes: "Interview ended by researcher from monitoring interface"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide the modal
                    endInterviewModal.hide();
                    
                    // Show notification
                    showNotification('Interview Ended', 'You have successfully ended the interview.', 'success');
                    
                    // Disable controls
                    messageInput.disabled = true;
                    sendBtn.disabled = true;
                    endInterviewBtn.disabled = true;
                    
                    // Socket will handle the UI update through session_completed event
                } else {
                    // Show error
                    showNotification('Error', data.error || 'Failed to end interview.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error ending interview:', error);
                showNotification('Error', 'Network error occurred while ending interview.', 'danger');
            });
        });
        
        // Function to initialize session statistics from existing messages
        function initializeSessionStats() {
            // Fetch existing messages to calculate initial stats
            fetch(`/api/session/${sessionId}/messages`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.messages && data.messages.length > 0) {
                        // Get session start time from the first message
                        if (data.messages[0] && data.messages[0].timestamp) {
                            sessionStartTime = new Date(data.messages[0].timestamp);
                        }
                        
                        // Process existing messages for stats
                        data.messages.forEach(message => {
                            const timestamp = new Date(message.timestamp || Date.now());
                            messageTimestamps.push(timestamp);
                            
                            if (message.role === 'assistant') {
                                interviewerMessageCount++;
                                if (message.content) {
                                    interviewerCharCount += message.content.length;
                                }
                            } else if (message.role === 'user') {
                                participantMessageCount++;
                                if (message.content) {
                                    participantCharCount += message.content.length;
                                }
                            }
                        });
                        
                        // Update stats display
                        updateSessionStats();
                    }
                })
                .catch(error => {
                    console.error('Error loading session messages:', error);
                });
        }
        
        // Initialize session stats when page loads
        initializeSessionStats();
        
        // Periodically refresh session stats to ensure accuracy
        setInterval(function() {
            fetch(`/api/session/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.session) {
                        // Update message count from actual session data
                        const messageCountElem = document.getElementById('message-count');
                        if (messageCountElem && data.session.messages) {
                            messageCountElem.textContent = data.session.messages.length;
                        }
                        
                        // Check if we should refresh all stats
                        if (data.session.messages && data.session.messages.length > participantMessageCount + interviewerMessageCount) {
                            console.log('Detected new messages, refreshing all stats...');
                            initializeSessionStats();
                        }
                    }
                })
                .catch(error => {
                    console.warn('Error refreshing session stats:', error);
                });
        }, 30000); // Refresh every 30 seconds
        
        // Add Note button click
        addNoteBtn.addEventListener('click', function() {
            addNoteModal.show();
        });
        
        // Save Note button click
        saveNoteBtn.addEventListener('click', function() {
            const noteText = document.getElementById('note-text').value.trim();
            const noteType = document.querySelector('input[name="noteType"]:checked').value;
            
            if (noteText) {
                // Send note through socket
                socket.emit('researcher_message', {
                    session_id: sessionId,
                    message: {
                        role: 'system',
                        content: noteText,
                        type: 'researcher_note',
                        note_type: noteType
                    }
                });
                
                // Hide modal and clear input
                document.getElementById('note-text').value = '';
                addNoteModal.hide();
                
                // Show confirmation
                showNotification('Note Added', 'Your research note has been saved.', 'success');
            }
        });
        
        // Quick suggestion buttons
        document.querySelectorAll('.quick-suggestion').forEach(button => {
            button.addEventListener('click', function() {
                const suggestion = this.getAttribute('data-suggestion');
                messageInput.value = suggestion;
                sendBtn.click();
            });
        });
        
        // Direct intervention buttons
        document.querySelectorAll('.direct-intervention').forEach(button => {
            button.addEventListener('click', function() {
                // Prevent multiple rapid clicks
                if (this.getAttribute('data-processing') === 'true') {
                    return;
                }
                
                // Disable the button temporarily
                this.setAttribute('data-processing', 'true');
                const originalText = this.innerHTML;
                this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...`;
                
                const intervention = this.getAttribute('data-intervention');
                let message = '';
                
                switch(intervention) {
                    case 'change-topic':
                        message = 'Please transition to the next topic.';
                        break;
                    case 'pause':
                        message = 'Take a brief pause and then continue with the interview.';
                        break;
                    case 'go-deeper':
                        message = 'Please explore this topic in more depth with follow-up questions.';
                        break;
                    case 'summarize':
                        message = 'Summarize the key points discussed so far.';
                        break;
                }
                
                // Send as a direct instruction rather than suggestion
                socket.emit('researcher_message', {
                    session_id: sessionId,
                    message: {
                        role: 'system',
                        content: message,
                        type: 'direct_question'
                    }
                });
                
                // Show confirmation
                showNotification('Intervention Sent', 'Your direction has been sent to the AI interviewer.', 'warning');
                
                // Re-enable the button after a delay
                const button = this;
                setTimeout(function() {
                    button.removeAttribute('data-processing');
                    button.innerHTML = originalText;
                }, 3000);
            });
        });
        
        // Function to add an insight to the key insights section
        function addInsight(text, type = 'observation', tags = []) {
            const insightsContainer = document.getElementById('key-insights');
            
            // Remove placeholder if present
            const placeholder = insightsContainer.querySelector('.text-center.text-muted');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Create insight element
            const insight = document.createElement('div');
            insight.className = 'insight-item';
            
            // Choose icon based on type
            let icon = 'bi-eye';
            if (type === 'key_point') icon = 'bi-star';
            if (type === 'question') icon = 'bi-question-circle';
            if (type === 'sentiment') icon = 'bi-emoji-smile';
            
            insight.innerHTML = `
                <i class="bi ${icon}"></i>
                <div class="insight-content">
                    <div>${text}</div>
                    ${tags.length > 0 ? `
                        <div class="ai-tags">
                            ${tags.map(tag => `<span class="ai-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            insightsContainer.prepend(insight);
        }

        // Initialize with a placeholder insight
        addInsight('Waiting for conversation to begin...', 'observation', ['system']);
        
        // Helper function to show notifications
        function showNotification(title, message, type) {
            // Create notification container if it doesn't exist
            if (!document.getElementById('notification-container')) {
                const container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'position-fixed top-0 end-0 p-3';
                container.style.zIndex = 1050;
                document.body.appendChild(container);
            }
            
            const notificationId = 'notification-' + new Date().getTime();
            const notification = document.createElement('div');
            notification.className = `toast show bg-${type} text-white`;
            notification.id = notificationId;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'assertive');
            notification.setAttribute('aria-atomic', 'true');
            
            notification.innerHTML = `
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            document.getElementById('notification-container').appendChild(notification);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Listen for new insights from AI
        socket.on('new_insights', function(data) {
            if (data.session_id === sessionId && data.insights) {
                console.log('New insights received:', data.insights);
                updateInsights(data.insights);
            }
        });
        
        // Function to update insights UI
        function updateInsights(insights) {
            const container = document.getElementById('key-insights');
            if (!container) return;
            
            // Clear placeholder if present
            const placeholder = container.querySelector('.text-center.text-muted');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Add each insight
            insights.slice(0, 3).forEach(insight => {
                // Skip if this insight already exists
                if (document.querySelector(`.insight-item[data-id="${insight.id}"]`)) {
                    return;
                }
                
                // Create insight element
                const insightElem = document.createElement('div');
                insightElem.className = 'insight-item mb-3';
                insightElem.setAttribute('data-id', insight.id);
                
                // Format importance badge
                let importanceClass = 'bg-secondary';
                let importanceIcon = 'info-circle';
                
                if (insight.importance) {
                    const importance = insight.importance.toUpperCase();
                    if (importance.includes('HIGH')) {
                        importanceClass = 'bg-danger';
                        importanceIcon = 'exclamation-circle';
                    } else if (importance.includes('MEDIUM')) {
                        importanceClass = 'bg-warning text-dark';
                        importanceIcon = 'asterisk';
                    }
                }
                
                insightElem.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="bi bi-lightbulb-fill text-primary me-2 mt-1"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="fw-medium">${insight.text}</span>
                                <span class="badge ${importanceClass} ms-2">
                                    <i class="bi bi-${importanceIcon} me-1"></i>
                                    ${insight.importance || 'MEDIUM'}
                                </span>
                            </div>
                            ${insight.evidence ? `<div class="text-muted small mt-1">${insight.evidence}</div>` : ''}
                        </div>
                    </div>
                `;
                
                // Insert at the top
                container.insertBefore(insightElem, container.firstChild);
            });
        }
        
        // Initialize - request insights on load
        socket.on('connect', function() {
            // We already have the join_monitor_room call
            // Add request for initial insights
            socket.emit('request_insights', { session_id: sessionId });
        });
        
        // Add refresh insights button to the key insights section
        document.getElementById('key-insights').parentElement.querySelector('h6').innerHTML += `
            <button id="refresh-insights-btn" class="btn btn-sm btn-link p-0 ms-auto float-end">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        `;
        
        // Add event listener for refresh insights button
        document.getElementById('refresh-insights-btn').addEventListener('click', function() {
            socket.emit('request_insights', { session_id: sessionId });
            showNotification('Refreshing', 'Requesting new insights...', 'info');
        });
    });
</script>
{% endblock %} 