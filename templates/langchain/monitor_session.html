{% extends "langchain/base.html" %}

{% block title %}Monitor Interview: {{ interview.title }}{% endblock %}

{% block extra_css %}
<style>
    .transcript-container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        overflow-y: auto;
        margin-right: 20px;
        display: flex;
        flex-direction: column;
        flex: 2;
    }
    .controls-container {
        width: 350px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    .status-indicator {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        background-color: #6c757d;
        margin-right: 5px;
    }
    .status-indicator.active {
        background-color: #28a745;
    }
    .transcript-content {
        flex: 1;
        white-space: pre-wrap;
        font-family: 'Inter', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        height: 65vh;
        overflow-y: auto;
    }
    .interviewer-message {
        color: #4f46e5;
        font-weight: 500;
        margin-bottom: 10px;
    }
    .participant-message {
        color: #212529;
        margin-bottom: 20px;
    }
    .control-label {
        font-weight: 500;
        margin-bottom: 5px;
    }
    .emotion-chart {
        height: 200px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    .sentiment-indicator {
        height: 25px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
    }
    .sentiment-level {
        position: absolute;
        height: 100%;
        background: linear-gradient(to right, #dc3545, #ffc107, #28a745);
        width: 100%;
    }
    .sentiment-marker {
        position: absolute;
        height: 25px;
        width: 3px;
        background-color: black;
        top: 0;
        z-index: 1;
    }
    .interview-stats {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }
    .interview-stats li {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }
    .interview-stats .value {
        font-weight: 500;
    }
    .suggestion-box {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }
    .live-indicator {
        display: inline-flex;
        align-items: center;
        padding: 5px 10px;
        background-color: rgba(220, 53, 69, 0.1);
        border-radius: 20px;
        color: #dc3545;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .live-indicator .dot {
        height: 8px;
        width: 8px;
        background-color: #dc3545;
        border-radius: 50%;
        margin-right: 5px;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.3;
        }
        100% {
            opacity: 1;
        }
    }
    .topic-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 20px;
    }
    .topic-tag {
        background-color: #e9ecef;
        padding: 3px 8px;
        border-radius: 15px;
        font-size: 0.8rem;
    }
    .btn-toolbar {
        margin-top: auto;
    }
    .monitor-container {
        display: flex;
        gap: 20px;
    }
    
    /* AI Observer Styles */
    .ai-note {
        background-color: rgba(79, 70, 229, 0.05);
        border-left: 3px solid rgba(79, 70, 229, 0.5);
        padding: 8px 12px;
        margin-top: 5px;
        font-size: 0.9rem;
        color: #495057;
        font-style: italic;
    }
    .ai-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 5px;
    }
    .ai-tag {
        background-color: rgba(79, 70, 229, 0.1);
        color: #4f46e5;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    .mood-timeline {
        height: 100px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        margin-bottom: 15px;
        position: relative;
    }
    .mood-point {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #4f46e5;
        transform: translate(-50%, -50%);
    }
    .observer-message {
        background-color: rgba(79, 70, 229, 0.03);
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .observer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .observer-icon {
        color: #4f46e5;
        margin-right: 5px;
    }
    .observer-title {
        font-size: 0.8rem;
        font-weight: 500;
        color: #4f46e5;
    }
    .observer-status {
        font-size: 0.75rem;
        color: #6c757d;
    }
    .observer-content {
        padding: 10px 12px;
    }
    .tab-controls {
        margin-bottom: 15px;
    }
    .toggle-observer {
        display: inline-flex;
        align-items: center;
        font-size: 0.8rem;
        color: #495057;
        cursor: pointer;
        user-select: none;
        margin-bottom: 10px;
    }
    .toggle-observer input {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3">Monitoring: {{ interview.title|default('Untitled Interview') }}</h1>
            <div class="text-muted small">Session ID: {{ session_id }}</div>
        </div>
        <div class="d-flex align-items-center">
            <div class="live-indicator me-3">
                <div class="dot"></div>
                <span>LIVE</span>
            </div>
            <button class="btn btn-outline-primary btn-sm me-2" id="suggestQuestionBtn">
                <i class="bi bi-lightbulb"></i> Suggest Question
            </button>
            <a href="/interview_details/{{ session_id }}" class="btn btn-outline-secondary btn-sm me-2">
                <i class="bi bi-info-circle"></i> Interview Details
            </a>
            <button class="btn btn-outline-danger btn-sm" id="endSessionBtn">
                <i class="bi bi-stop-circle"></i> End Session
            </button>
        </div>
    </div>

    <div class="monitor-container">
        <div class="transcript-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h5 mb-0">Live Transcript</h2>
                <div>
                    <label class="toggle-observer me-3">
                        <input type="checkbox" id="toggleAIObserver" checked> 
                        <span>AI Observer</span>
                    </label>
                    <button class="btn btn-sm btn-outline-secondary" id="copyTranscriptBtn">
                        <i class="bi bi-clipboard"></i> Copy Transcript
                    </button>
                </div>
            </div>
            <div class="transcript-content" id="transcriptContent">
                {{ transcript }}
            </div>
        </div>
        <div class="controls-container">
            <div class="tab-controls">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="researcher-tab" data-bs-toggle="tab" data-bs-target="#researcher-pane" type="button" role="tab">Researcher</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="observer-tab" data-bs-toggle="tab" data-bs-target="#observer-pane" type="button" role="tab">AI Observer</button>
                    </li>
                </ul>
            </div>
            
            <div class="tab-content">
                <div class="tab-pane fade show active" id="researcher-pane" role="tabpanel">
                    <h3 class="h5 mb-3">Interview Analytics</h3>
                    
                    <div class="control-label">Sentiment Tracking</div>
                    <div class="sentiment-indicator mb-1">
                        <div class="sentiment-level"></div>
                        <div class="sentiment-marker" style="left: 50%;"></div>
                    </div>
                    <div class="d-flex justify-content-between mb-3 small text-muted">
                        <span>Negative</span>
                        <span>Neutral</span>
                        <span>Positive</span>
                    </div>
                    
                    <div class="control-label">Key Topics Mentioned</div>
                    <div class="topic-list" id="topicList">
                        <span class="topic-tag">Product Features</span>
                        <span class="topic-tag">User Experience</span>
                        <span class="topic-tag">Interface Design</span>
                        <span class="topic-tag">Customer Support</span>
                        <span class="topic-tag">Documentation</span>
                    </div>
                    
                    <div class="control-label">Interview Stats</div>
                    <ul class="interview-stats">
                        <li>
                            <span class="label">Duration</span>
                            <span class="value" id="durationValue">00:05:32</span>
                        </li>
                        <li>
                            <span class="label">Questions Asked</span>
                            <span class="value" id="questionsValue">6</span>
                        </li>
                        <li>
                            <span class="label">Avg. Response Time</span>
                            <span class="value" id="responseTimeValue">12.4 sec</span>
                        </li>
                        <li>
                            <span class="label">Interviewer Talk Time</span>
                            <span class="value" id="interviewerTimeValue">35%</span>
                        </li>
                        <li>
                            <span class="label">Participant Talk Time</span>
                            <span class="value" id="participantTimeValue">65%</span>
                        </li>
                    </ul>
                    
                    <div class="control-label">Researcher Notes</div>
                    <div class="suggestion-box" id="suggestionBox">
                        Consider asking about their specific pain points with the current process. The participant has mentioned challenges but hasn't specified details.
                    </div>
                </div>
                
                <div class="tab-pane fade" id="observer-pane" role="tabpanel">
                    <h3 class="h5 mb-3">AI Observer Analysis</h3>
                    
                    <div class="control-label">Sentiment Timeline</div>
                    <div class="mood-timeline" id="moodTimeline">
                        <!-- Mood points will be added dynamically -->
                    </div>
                    <div class="d-flex justify-content-between mb-3 small text-muted">
                        <span>Negative</span>
                        <span>Neutral</span>
                        <span>Positive</span>
                    </div>
                    
                    <div class="control-label">Current Mood</div>
                    <div class="sentiment-indicator mb-3">
                        <div class="sentiment-level"></div>
                        <div class="sentiment-marker" id="aiMoodMarker" style="left: 50%;"></div>
                    </div>
                    
                    <div class="control-label">Semantic Tags</div>
                    <div class="topic-list" id="aiTopicList">
                        <!-- AI-generated tags will appear here -->
                    </div>
                    
                    <div class="control-label">Latest Observation</div>
                    <div class="observer-message">
                        <div class="observer-header">
                            <div>
                                <i class="bi bi-robot observer-icon"></i>
                                <span class="observer-title">AI Observer</span>
                            </div>
                            <span class="observer-status">Analyzing...</span>
                        </div>
                        <div class="observer-content" id="latestObservation">
                            <!-- Latest AI observation will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="btn-toolbar">
                <button class="btn btn-outline-secondary me-2" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
                <button class="btn btn-primary" id="downloadReportBtn">
                    <i class="bi bi-download"></i> Download Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Suggest Question Modal -->
<div class="modal fade" id="suggestQuestionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Suggest Follow-up Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="suggestedQuestion" class="form-label">Question Suggestion</label>
                    <select class="form-select mb-3" id="suggestedQuestion">
                        <option value="1">Could you elaborate on the challenges you mentioned with the user interface?</option>
                        <option value="2">How does this compare to other similar products you've used before?</option>
                        <option value="3">What would be your ideal solution to the issues you've described?</option>
                        <option value="4">Could you walk me through a specific example where you encountered this problem?</option>
                    </select>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="customQuestionCheck">
                        <label class="form-check-label" for="customQuestionCheck">
                            Write a custom question
                        </label>
                    </div>
                </div>
                <div class="mb-3" id="customQuestionContainer" style="display: none;">
                    <label for="customQuestion" class="form-label">Custom Question</label>
                    <textarea class="form-control" id="customQuestion" rows="3" placeholder="Type your question here..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendQuestionBtn">Send to Interviewer</button>
            </div>
        </div>
    </div>
</div>

<!-- End Session Modal -->
<div class="modal fade" id="endSessionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">End Interview Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to end this interview session? This will signal to Daria to wrap up the interview.</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="generateAnalysisCheck" checked>
                    <label class="form-check-label" for="generateAnalysisCheck">
                        Generate comprehensive analysis report
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmEndSession">End Session</button>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Interview Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4" id="analysisLoading">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Generating analysis...</p>
                </div>
                <div id="analysisContent" style="display: none;">
                    <h4 class="mb-3">Key Insights</h4>
                    <div id="analysisText" class="mb-4"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadAnalysisBtn">Download</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Constants
        const sessionId = '{{ session_id }}';
        
        // Elements
        const transcriptContent = document.getElementById('transcriptContent');
        const topicList = document.getElementById('topicList');
        const durationValue = document.getElementById('durationValue');
        const questionsValue = document.getElementById('questionsValue');
        const responseTimeValue = document.getElementById('responseTimeValue');
        const interviewerTimeValue = document.getElementById('interviewerTimeValue');
        const participantTimeValue = document.getElementById('participantTimeValue');
        const suggestQuestionBtn = document.getElementById('suggestQuestionBtn');
        const endSessionBtn = document.getElementById('endSessionBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const copyTranscriptBtn = document.getElementById('copyTranscriptBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const downloadAnalysisBtn = document.getElementById('downloadAnalysisBtn');
        const sendQuestionBtn = document.getElementById('sendQuestionBtn');
        const confirmEndSessionBtn = document.getElementById('confirmEndSessionBtn');
        const customQuestionCheck = document.getElementById('customQuestionCheck');
        const analysisLoading = document.getElementById('analysisLoading');
        const analysisContent = document.getElementById('analysisContent');
        const analysisText = document.getElementById('analysisText');
        
        // AI Observer elements
        const toggleAIObserver = document.getElementById('toggleAIObserver');
        const aiTopicList = document.getElementById('aiTopicList');
        const moodTimeline = document.getElementById('moodTimeline');
        const aiMoodMarker = document.getElementById('aiMoodMarker');
        const latestObservation = document.getElementById('latestObservation');
        
        // Modals
        const suggestQuestionModal = new bootstrap.Modal(document.getElementById('suggestQuestionModal'));
        const endSessionModal = new bootstrap.Modal(document.getElementById('endSessionModal'));
        const analysisModal = new bootstrap.Modal(document.getElementById('analysisModal'));
        
        // State
        let lastTranscriptLength = 0;
        let isInterviewEnded = false;
        let pollInterval;
        let checkStatusInterval;
        
        // AI Observer state
        let isAIObserverEnabled = true;
        let observerMoodData = [];
        let observerTagList = [];
        let lastProcessedMessageId = null;
        let currentMood = { value: 0, label: "Neutral" };
        
        // Functions
        function handleInterviewEnded() {
            // Update UI for ended interview
            document.querySelector('.live-indicator').classList.remove('live-indicator');
            document.querySelector('.dot').classList.remove('dot');
            
            // Clear intervals
            clearInterval(pollInterval);
            clearInterval(checkStatusInterval);
            
            // Disable buttons
            suggestQuestionBtn.disabled = true;
            endSessionBtn.disabled = true;
        }
        
        function pollTranscript() {
            if (isInterviewEnded) return;
            
            fetch(`/langchain/api/interview/transcript?session_id=${sessionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    if (data.content) {
                        // Update transcript
                        transcriptContent.innerHTML = data.content;
                        
                        // Process new transcript chunks with AI Observer if enabled
                        if (isAIObserverEnabled && data.transcript_chunks) {
                            processNewTranscriptChunks(data.transcript_chunks);
                        }
                        
                        // Check if content has changed
                        if (data.content.length !== lastTranscriptLength) {
                            lastTranscriptLength = data.content.length;
                            // Scroll to bottom of transcript
                            transcriptContent.scrollTop = transcriptContent.scrollHeight;
                        }
                    }
                    
                    // Update stats if available
                    if (data.stats) {
                        if (data.stats.duration) durationValue.textContent = data.stats.duration;
                        if (data.stats.questions_count) questionsValue.textContent = data.stats.questions_count;
                        if (data.stats.avg_response_time) responseTimeValue.textContent = data.stats.avg_response_time;
                        if (data.stats.interviewer_percentage) interviewerTimeValue.textContent = data.stats.interviewer_percentage;
                        if (data.stats.participant_percentage) participantTimeValue.textContent = data.stats.participant_percentage;
                    }
                    
                    // Update topics if available
                    if (data.topics && data.topics.length > 0) {
                        topicList.innerHTML = '';
                        data.topics.forEach(topic => {
                            const topicTag = document.createElement('span');
                            topicTag.className = 'topic-tag';
                            topicTag.textContent = topic;
                            topicList.appendChild(topicTag);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error polling transcript:', error);
            });
        }
        
        function checkInterviewStatus() {
            if (isInterviewEnded) return;
            
            fetch(`/langchain/api/interview/status?session_id=${sessionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    if (data.interview_status === 'completed' || data.interview_status === 'ended') {
                        isInterviewEnded = true;
                        handleInterviewEnded();
                    }
                }
            })
            .catch(error => {
                console.error('Error checking interview status:', error);
            });
        }
        
        // AI Observer functions
        function processNewTranscriptChunks(chunks) {
            if (!isAIObserverEnabled || !chunks || chunks.length === 0) return;
            
            // Find the last message that hasn't been processed
            let lastUnprocessedIndex = -1;
            for (let i = chunks.length - 1; i >= 0; i--) {
                if (chunks[i].id !== lastProcessedMessageId) {
                    lastUnprocessedIndex = i;
                    break;
                }
            }
            
            if (lastUnprocessedIndex === -1) return; // No new messages
            
            // Get the chunk to process
            const chunkToProcess = chunks[lastUnprocessedIndex];
            lastProcessedMessageId = chunkToProcess.id;
            
            // Add AI observer note to UI
            processTranscriptChunk(chunkToProcess);
        }
        
        function processTranscriptChunk(chunk) {
            // Call the API to analyze the transcript chunk
            fetch('/api/observer/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    transcript_chunk: chunk,
                    session_id: sessionId,
                    previous_mood: currentMood,
                    previous_tags: observerTagList
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.result) {
                    const result = data.result;
                    
                    // Update latest observation
                    if (result.observer_notes) {
                        latestObservation.textContent = result.observer_notes;
                    }
                    
                    // Update semantic tags
                    if (result.semantic_tags && result.semantic_tags.length > 0) {
                        // Add tags to message in transcript
                        const messageElement = findMessageElementById(chunk.id);
                        if (messageElement) {
                            addAINotesToMessage(messageElement, result);
                        }
                    }
                    
                    // Update mood
                    if (result.observer_mood) {
                        updateMood(result.observer_mood);
                    }
                    
                    // Update tag list
                    if (result.observer_tag_list) {
                        updateTagList(result.observer_tag_list);
                    }
                }
            })
            .catch(error => {
                console.error('Error analyzing transcript chunk:', error);
            });
        }
        
        function findMessageElementById(messageId) {
            // This is a placeholder - you'll need to implement a way to find message elements
            // One way is to add data-id attributes to messages when they're added to the UI
            return document.querySelector(`[data-message-id="${messageId}"]`);
        }
        
        function addAINotesToMessage(messageElement, analysis) {
            if (!messageElement) return;
            
            // Check if AI notes already exist
            if (messageElement.querySelector('.ai-note')) return;
            
            // Add AI notes
            if (analysis.observer_notes) {
                const noteElement = document.createElement('div');
                noteElement.className = 'ai-note';
                noteElement.innerHTML = `<i class="bi bi-robot me-1"></i> ${analysis.observer_notes}`;
                messageElement.appendChild(noteElement);
            }
            
            // Add tags
            if (analysis.semantic_tags && analysis.semantic_tags.length > 0) {
                const tagsElement = document.createElement('div');
                tagsElement.className = 'ai-tags';
                
                analysis.semantic_tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'ai-tag';
                    tagElement.textContent = tag;
                    tagsElement.appendChild(tagElement);
                });
                
                messageElement.appendChild(tagsElement);
            }
        }
        
        function updateMood(mood) {
            if (!mood) return;
            
            // Update current mood
            currentMood = mood;
            
            // Add to mood data array with timestamp
            observerMoodData.push({
                value: mood.value,
                timestamp: mood.timestamp || new Date().toISOString()
            });
            
            // Update mood marker position (convert from -1:1 to 0:100)
            const position = ((mood.value + 1) / 2) * 100;
            aiMoodMarker.style.left = `${position}%`;
            
            // Update mood timeline visualization
            updateMoodTimeline();
        }
        
        function updateMoodTimeline() {
            // Clear existing points
            moodTimeline.innerHTML = '';
            
            // Skip if no data
            if (observerMoodData.length === 0) return;
            
            // Calculate time range
            const firstTime = new Date(observerMoodData[0].timestamp).getTime();
            const lastTime = new Date(observerMoodData[observerMoodData.length - 1].timestamp).getTime();
            const timeRange = lastTime - firstTime;
            
            // Add points
            observerMoodData.forEach((point, index) => {
                const pointElement = document.createElement('div');
                pointElement.className = 'mood-point';
                
                // Calculate position (x: time, y: mood value)
                const time = new Date(point.timestamp).getTime();
                const xPercent = timeRange === 0 ? 50 : ((time - firstTime) / timeRange) * 100;
                const yPercent = ((1 - point.value) / 2) * 100; // Convert -1:1 to 0:100 inverted (0 at bottom)
                
                pointElement.style.left = `${xPercent}%`;
                pointElement.style.top = `${yPercent}%`;
                
                // Size based on recency
                const size = index === observerMoodData.length - 1 ? 10 : 6;
                pointElement.style.width = `${size}px`;
                pointElement.style.height = `${size}px`;
                
                // Color based on value
                let color;
                if (point.value < -0.3) color = '#dc3545'; // negative
                else if (point.value > 0.3) color = '#28a745'; // positive
                else color = '#ffc107'; // neutral
                
                pointElement.style.backgroundColor = color;
                
                moodTimeline.appendChild(pointElement);
            });
        }
        
        function updateTagList(tags) {
            if (!tags || tags.length === 0) return;
            
            // Update local state
            observerTagList = tags;
            
            // Update UI
            aiTopicList.innerHTML = '';
            
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'topic-tag';
                tagElement.textContent = tag;
                aiTopicList.appendChild(tagElement);
            });
        }
        
        // Event Handlers
        toggleAIObserver.addEventListener('change', (e) => {
            isAIObserverEnabled = e.target.checked;
            
            // Toggle AI notes in transcript
            document.querySelectorAll('.ai-note, .ai-tags').forEach(el => {
                el.style.display = isAIObserverEnabled ? 'block' : 'none';
            });
        });
        
        copyTranscriptBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(transcriptContent.textContent)
            .then(() => {
                // Create a temporary message to show that copy was successful
                const copyMessage = document.createElement('div');
                copyMessage.textContent = 'Copied to clipboard!';
                copyMessage.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                copyMessage.style.zIndex = '9999';
                document.body.appendChild(copyMessage);
                
                // Remove the message after 2 seconds
                setTimeout(() => {
                    document.body.removeChild(copyMessage);
                }, 2000);
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
                alert('Failed to copy text to clipboard');
            });
        });
        
        // Custom question checkbox toggle
        customQuestionCheck.addEventListener('change', () => {
            const customQuestionInput = document.getElementById('customQuestion');
            const suggestedQuestionSelect = document.getElementById('suggestedQuestion');
            
            if (customQuestionCheck.checked) {
                customQuestionInput.disabled = false;
                suggestedQuestionSelect.disabled = true;
            } else {
                customQuestionInput.disabled = true;
                suggestedQuestionSelect.disabled = false;
            }
        });
        
        suggestQuestionBtn.addEventListener('click', () => {
            suggestQuestionModal.show();
        });
        
        endSessionBtn.addEventListener('click', () => {
            endSessionModal.show();
        });
        
        sendQuestionBtn.addEventListener('click', () => {
            let question;
            
            if (customQuestionCheck.checked) {
                question = document.getElementById('customQuestion').value.trim();
                if (!question) {
                    alert('Please enter a custom question');
                    return;
                }
            } else {
                const select = document.getElementById('suggestedQuestion');
                question = select.options[select.selectedIndex].text;
            }
            
            // Send the suggested question to the interviewer
            fetch('/langchain/api/interview/suggest-question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    question: question
                })
            })
            .then(response => {
                // First check if the response is ok before trying to parse JSON
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('Question suggestion sent to the interviewer');
                } else {
                    alert('Error sending suggestion: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending suggestion: ' + error);
            });
            
            suggestQuestionModal.hide();
        });
        
        confirmEndSessionBtn.addEventListener('click', () => {
            const generateAnalysis = document.getElementById('generateAnalysisCheck').checked;
            
            // Show the loading indicator if generating analysis
            if (generateAnalysis) {
                analysisLoading.style.display = 'block';
                analysisContent.style.display = 'none';
            }
            
            // Send the end session request
            fetch('/langchain/api/interview/end', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    generate_analysis: generateAnalysis
                })
            })
            .then(response => {
                // First check if the response is ok before trying to parse JSON
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Close the end session modal
                    endSessionModal.hide();
                    
                    // Mark interview as ended
                    isInterviewEnded = true;
                    handleInterviewEnded();
                    
                    // If analysis was generated, show it
                    if (generateAnalysis && data.analysis) {
                        analysisLoading.style.display = 'none';
                        analysisContent.style.display = 'block';
                        analysisText.innerHTML = data.analysis.replace(/\n/g, '<br>');
                        analysisModal.show();
                    } else {
                        alert('Interview session ended successfully');
                    }
                } else {
                    alert('Error ending session: ' + (data.error || 'Unknown error'));
                    endSessionModal.hide();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error ending session: ' + error);
                endSessionModal.hide();
            });
        });
        
        refreshBtn.addEventListener('click', () => {
            pollTranscript();
        });
        
        downloadReportBtn.addEventListener('click', () => {
            // Create report content with AI Observer data if available
            let aiObserverSection = '';
            if (isAIObserverEnabled && observerTagList.length > 0) {
                aiObserverSection = `
## AI Observer Analysis
- Current Mood: ${currentMood.label} (${currentMood.value})
- Semantic Tags: ${observerTagList.map(tag => tag).join(', ')}
- Latest Observation: ${latestObservation.textContent || 'No observations yet'}
`;
            }
            
            const reportContent = `# Interview Monitoring Report
Session ID: ${sessionId}
Date: ${new Date().toLocaleString()}

## Transcript
${transcriptContent.textContent}

## Statistics
- Duration: ${document.getElementById('durationValue').textContent}
- Questions Asked: ${document.getElementById('questionsValue').textContent}
- Avg. Response Time: ${document.getElementById('responseTimeValue').textContent}
- Interviewer Talk Time: ${document.getElementById('interviewerTimeValue').textContent}
- Participant Talk Time: ${document.getElementById('participantTimeValue').textContent}

## Key Topics
${Array.from(document.querySelectorAll('.topic-tag')).map(tag => '- ' + tag.textContent).join('\n')}

## Researcher Notes
${document.getElementById('suggestionBox').textContent}
${aiObserverSection}
`;

            // Create and download the file
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interview_report_${sessionId}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        downloadAnalysisBtn.addEventListener('click', () => {
            // Create report content with analysis
            const analysisContent = analysisText.innerText || '';
            const reportContent = `# Interview Analysis Report
Session ID: ${sessionId}
Date: ${new Date().toLocaleString()}

## Analysis
${analysisContent}

## Transcript
${transcriptContent.textContent}

## Statistics
- Duration: ${document.getElementById('durationValue').textContent}
- Questions Asked: ${document.getElementById('questionsValue').textContent}
- Avg. Response Time: ${document.getElementById('responseTimeValue').textContent}
- Interviewer Talk Time: ${document.getElementById('interviewerTimeValue').textContent}
- Participant Talk Time: ${document.getElementById('participantTimeValue').textContent}

## Key Topics
${Array.from(document.querySelectorAll('.topic-tag')).map(tag => '- ' + tag.textContent).join('\n')}

## AI Observer Tags
${observerTagList.map(tag => '- ' + tag).join('\n')}
`;

            // Create and download the file
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interview_analysis_${sessionId}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // Start polling and status checking
        pollInterval = setInterval(pollTranscript, 5000);
        checkStatusInterval = setInterval(checkInterviewStatus, 5000);
        
        // Initialize the page
        pollTranscript();
    });
</script>
{% endblock %} 